---
title: "Management Parameters"
author: "Jill Deines"
date: "November 14, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Retrieve crop management parameters from the NASS Quickstats API

Functions to package up:

* get planting progress/dates from NASS

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.28_salus_management/',
                      cache = TRUE, cache.path='cache/02.28_salus_management/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
# for API interaction
library(httr) 
library(jsonlite)
```

** Directories **

```{r dirVars}
managementDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/management'
```


# Functions: NASS Quick Stats API 

* API website: http://quickstats.nass.usda.gov/api
* My API key: 28EAA9E6-8060-34A4-981A-B2ED4692228A

## Function: Get Planting Dates By Commodity, Year

Arguments:
Everything hard-coded except commodity, year, and state 

* apiKey: Obtained from http://quickstats.nass.usda.gov/api
* program: 'SURVEY' (other option: 'CENSUS'; survey is hardcoded)
* sector: 'CROPS' here 
* group: 'FIELD CROPS' 
* Commodity: 'CORN' ('WHEAT', 'SORGHUM','SOYBEANS')
* Category: 'PROGRESS'
* Data Item: 'CORN - PROGRESS, MEASURED IN PCT PLANTED'
* Domain: 'TOTAL'
* Geographic Level: 'STATE'
* State: 'KANSAS' 
* Year: '2006' = start  year; retrieves data for all subsequent years

Requires: `httr` and `jsonlite`

```{r fun_plantingDate}
apiKey <- '28EAA9E6-8060-34A4-981A-B2ED4692228A'
commodity <- 'CORN'
shortDesc <- 'CORN - PROGRESS, MEASURED IN PCT PLANTED'
state <- 'KANSAS'
year <- 2006

getPlantingDate <- function(apikey, commodity, shortDesc, state, year){
  # build URL query
  baseurl <- 'http://quickstats.nass.usda.gov/api/api_GET'
  format = 'JSON'
  GETrequest <- paste0(baseurl,
                     '/?key=',apiKey,
                     '&source_desc=','SURVEY',
                     '&sector_desc=','CROPS',
                     '&group_desc=','FIELD CROPS',
                     '&commodity_desc=',commodity,
                     '&statisticcat_desc=','PROGRESS',
                     '&short_desc=', shortDesc,
                     '&domain_desc=', 'TOTAL',
                     '&agg_level_desc=', 'STATE',
                     '&state_name=', 'KANSAS',
                     '&year__GE=', year,
                     '&format=',format)
  
  # if present, replace commas and spaces in url with encodings
  if(grepl(" ", GETrequest))  GETrequest <- gsub(" ", "%20", GETrequest)
  if(grepl(",", GETrequest))  GETrequest <- gsub(",", "%2C", GETrequest)
  
  # retrive data
  req <- GET(GETrequest)
  # check status and throw stop/error: 200 means successful
  stop_for_status(req)
  # extract content
  json <- content(req, as = 'text')
  # convert from JSON and extract df from list object
  outputdf <- fromJSON(json)[[1]]
}
```


# Get data

## Planting Dates

```{r getDates, eval=FALSE}
# planting date arguments
apiKey <- '28EAA9E6-8060-34A4-981A-B2ED4692228A'
state <- 'KANSAS'
year <- 2006

# crops wanted and their short description (wheat complicates)
dataItemBase <- ' - PROGRESS, MEASURED IN PCT PLANTED'
cropsWanted <- data.frame(crop = c('CORN','WHEAT','SORGHUM','SOYBEANS'),
                          short = c(paste0('CORN', dataItemBase),
                                    paste0('WHEAT, WINTER', dataItemBase),
                                    paste0('SORGHUM', dataItemBase),
                                    paste0('SOYBEANS', dataItemBase)))

# stick all crops into a list of crop dfs
dates.list <- list()
for(i in 1:nrow(cropsWanted)){
  dates.list[[i]] <- getPlantingDate(apiKey, cropsWanted[i,1], cropsWanted[i,2], state, year)
}

# convert list of data frames to 1 giant dataframe
dates.df <- do.call("rbind",dates.list)

# write out raw NASS data in case the API breaks in the future
write.csv(dates.df, row.names=FALSE, 
  file = paste0(managementDir,'/NASS_plantingDates_KS_2006-2017_4crops_RAW.csv'))
```


