---
title: "Process Salus Results"
author: "Jill Deines"
date: "December 4, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Build SALUS results workflow to process LEMA output back into a spatial grid

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/03.20_salus_results_process/',
                      cache = FALSE, cache.path='cache/03.20_salus_results_lema/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
# trying to include package::function but the order of these two packages 
# will matter if I forget
library(raster)  
library(tidyverse)
library(rgdal)
#library(devtools)
#install_github("jdeines/salustools")
library(salustools)
```

**Directories and User Variables**

```{r dirs}
# directory for cleaned/summarized to annual values salus output
resultsDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/experiments/LEMA_historical_autoIrrigation_v02/results'

# run name
runname <- 'lema_historic_auto_v02'

# time frame
startYear <- 2006 # excluding wheat planting, aka first year of harvest
endYear <- 2016

# load unique experiments and grid cell to Experiment code key
#comboDir <- 'S:/Users/deinesji/HPA/Salus/lema/uniqueExperiments'
comboDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/combinationGrids/spatialFilters'
load(file = paste0(comboDir,'/uniqueExperiments_gmd4p_Sheridan6_top6.RData'))

# gmd4+ template raster grid (based on CDL clipped to study region boundary)
aeaProj <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
template <- raster(nrow = 4359, ncol = 7108, crs = aeaProj,
                    xmn = -522870, xmx = -309630, ymn = 1777860, 
                    ymx = 1908630) 
template[] <- 1:ncell(template)
templateVector <- getValues(template)

# aoi
gisDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/GIS/boundaries'
aoi <- readOGR(gisDir, 'Sheridan6_fromKGS_sd6', verbose = FALSE)
aoi <- spTransform(aoi, CRS(aeaProj))
```

# SALUS Maps and Summaries

## Load Data and get Expt Distributions
Results need to be distributed in space, but first, taken a quick glance at the unweighted results for the experiments run

### YIeld

```{r unweightedYieldResults, fig.width = 5, fig.height = 4.25}
# load formatted results output
expt.annual <- read_csv(paste0(resultsDir, '/', runname, '.csv'))

# get yield statistics by year/crop/irrigation status (not spatially weighted)
# species names
cropKey <- data.frame(SpeciesID = c('MZ', 'WH','SB','SG','AL'),
                      crop = c('CORN','WHEAT','SOYBEANS','SORGHUM','ALFALFA'))

uYieldStats <- expt.annual %>%
  filter(SpeciesID %in% cropKey$SpeciesID) %>%
  group_by(Year, SpeciesID, irrigation) %>%
  do(data.frame(t(quantile(.$GWAD, probs = c(.1, .25, .5, .75, .9),na.rm=TRUE)))) %>%
  left_join(cropKey)

# plot
ggplot(uYieldStats, aes(x=Year, y = X50., color = irrigation)) +
  geom_ribbon(aes(x = Year, ymin = X25., ymax = X75., fill=irrigation), alpha = .4) +
  geom_line() +
  facet_wrap(~crop) +
  ylab('Yield (kg/ha)') + xlab('') + 
  ggtitle('Median and IQR Yield, Lema Unweighted Experiments') +
  theme_bw() + theme(legend.position = 'bottom')#, legend.title = element_blank())
```

### Irrigation Water Used

```{r unweightedIrrResults, fig.height = 2.5, fig.width = 4}
# get summary statistics for all irrigated experiments
uIrrStats <- expt.annual %>%
  filter(irrigation == 'Y') %>%
  group_by(Year) %>%
  do(data.frame(t(quantile(.$IRRC_mm, probs = c(.1, .25, .5, .75, .9),na.rm=TRUE))))

# plot
ggplot(uIrrStats, aes(x=Year, y = X50.)) +
  geom_ribbon(aes(x = Year, ymin = X25., ymax = X75.), alpha = .4) +
  geom_line() +
  ylab('Irrigation (mm)') + xlab('') + 
  ggtitle('Median and IQR Irrigation Applied, Lema Unweighted Experiments') +
  theme_bw() 
```

### Precipitation

```{r unweightedPrecip, fig.height = 2.5, fig.width = 4}
uIPrecipStats <- expt.annual %>%
  group_by(Year) %>%
  do(data.frame(t(quantile(.$PREC_mm, probs = c(.1, .25, .5, .75, .9),na.rm=TRUE))))

ggplot(uIPrecipStats, aes(x=Year, y = X50.)) +
  geom_ribbon(aes(x = Year, ymin = X25., ymax = X75.), alpha = .4) +
  geom_line() +
  ylab('Precip (mm)') + xlab('') + 
  ggtitle('Median and IQR Precip, Lema Unweighted Experiments') +
  theme_bw() 
```


## Spatially Distribute
Distribute results based on grid cell ids

### Irrigation

```{r spatialize}
# load formatted results output
expt.annual <- read_csv(paste0(resultsDir, '/', runname, '.csv'))
irrVar <- 'IRRC_mm'

# vector of years wanted
yearsWanted <- startYear:endYear

# irrigation stack
irrList <- list()
for(year in yearsWanted){
  rasName <- as.character(year)
  irrList[[rasName]] <- salustools::spatialize(expt.annual, irrVar, year, 
                                        gridExps, template,aoi)
}  
irrStack <- stack(irrList, quick = TRUE)

spplot(irrStack, main = runname)

# get total irrigation over time


```

