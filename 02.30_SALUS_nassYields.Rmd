---
title: "NASS County Yields"
author: "Jill Deines"
date: "November 15, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Retrieve crop yields by county from the NASS Quickstats API. 

Functions to package up:

* get yields from NASS - incorporated with the management function, or a separate one (many small, one large?)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.30_salus_nassYields/',
                      cache = TRUE, cache.path='cache/02.30_salus_nassYields/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
# for API interaction
library(httr) 
library(jsonlite)


```

**Directories**

```{r dirVars}
# place to store output
yieldDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/nass_yield'
```


# Functions: NASS Quick Stats API 

* API website: http://quickstats.nass.usda.gov/api

## Function: Get Progress or densities By Commodity, Year
So far this works for progress dates (ie, planting, maturity, harvest) and row width/population numbers. So I should probably change its name.

Arguments:
Everything currently hard-coded except commodity, category, shortDesc, year, and state 

Current hard coded: 

* program: 'SURVEY' (other option: 'CENSUS'; survey is hardcoded)
* group: 'FIELD CROPS' 
* Domain: 'TOTAL'
* Geographic Level: 'STATE'

Function parameters:

* apiKey: Obtained from http://quickstats.nass.usda.gov/api
* sector: usually 'CROPS'; 'ENVIRONMENTAL' for fertilizer
* Commodity: 'CORN' ('WHEAT', 'SORGHUM','SOYBEANS')
* Category: 'PROGRESS' ('ROW WIDTH', etc)
* Data Item/ short desc: ' - PROGRESS, MEASURED IN PCT PLANTED' ...etc, pasted to crop type but not exactly
* State: 'KANSAS' 
* Year: '2006' = start  year; retrieves data for all subsequent years

Requires: `httr` and `jsonlite`

```{r fun_getPlantingDate}
## function testing variables
# apiKey <- '28EAA9E6-8060-34A4-981A-B2ED4692228A'
# commodity <- 'CORN'
# shortDesc <- 'CORN - PROGRESS, MEASURED IN PCT PLANTED'
# category <- 'PROGRESS'
# state <- 'KANSAS'
# year <- 2006

getPlantingDate <- function(apikey, sector, commodity, category, shortDesc, state, year){
  # build URL query
  baseurl <- 'http://quickstats.nass.usda.gov/api/api_GET'
  format = 'JSON'
  GETrequest <- paste0(baseurl,
                     '/?key=',apiKey,
                     '&source_desc=', 'SURVEY',
                     '&sector_desc=', sector,
                     '&group_desc=', 'FIELD CROPS',
                     '&commodity_desc=', commodity,
                     '&statisticcat_desc=', category,
                     '&short_desc=', shortDesc,
                     '&domain_desc=', 'TOTAL',
                     '&agg_level_desc=', 'STATE',
                     '&state_name=', state,
                     '&year__GE=', year,
                     '&format=', format)
  
  # if present, replace commas and spaces in url with encodings
  if(grepl(" ", GETrequest))  GETrequest <- gsub(" ", "%20", GETrequest)
  if(grepl(",", GETrequest))  GETrequest <- gsub(",", "%2C", GETrequest)
  
  # retrive data
  req <- GET(GETrequest)
  # check status and throw stop/error: 200 means successful
  stop_for_status(req)
  # extract content
  json <- content(req, as = 'text')
  # convert from JSON and extract df from list object
  outputdf <- fromJSON(json)[[1]]
}
```
