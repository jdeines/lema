---
title: "Generate Salus Experiment Files"
author: "Jill Deines"
date: "November 23, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Make Experiment Files; here, for LEMA, historical, auto irrigation. Strategy: make 1 file for each NLDAS grid, containing all experiments. Or maybe for each NLDAS/soil combo.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.52_salus_expt_lema/',
                      cache = TRUE, cache.path='cache/02.52_salus_expt_lema/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(stringr)
library(sf)
library(salustools) # from Jill's github
library(lubridate)
library(viridis)
```

**Directories**
Not all of them are here. It's a fast messy world.

```{r dirs}
rootDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus'
expSubDir <- '/experiments/LEMA_historical_autoIrrigation_v01'
expFileSuffix <- '_LEMA_historic_auto.xdb.xml'
```

## Extract some management info
Combine planting dates, spacing information, cultivars, etc

From Lydia and Brian:  

**Cultivars:**

* maize: complex model, cultivar MZH, speciesID 'MZ'
* wheat: complex model, cultivar IB1015, 'WH'
  * also a simple winter wheat: 'WW'
* soybeans: simple model (no cultivars) - species ID = 'SB'
* sorghum: simple model (no cultivars) - 'SG'
* grassland - a few grasses or generic pasture. 
  * grass-weeds, speciesID ='GW' - possible complex?
  * generic-pasture: 'PA' - definitely a simple
* fallow: just set the planting date for the next crop and let bare soil run. There does also seem to be a Fallow option (speciesID 'FA')

```{r getManagement}
startYear <- 2006
endYear <- 2016
Nyrs <- 11
startDOY <- 265
runTitle <- 'Lema_historic_01'
# adjust start year for winter wheat planting
wheatStart <- startYear -1

# load date file
managementDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/management'
dates <- read.csv(paste0(managementDir,'/NASS_dates_planting_maturity_harvest_KS_2006-2017_4crops_MEDIANs.csv'))

# crop parameter key
cropParamKey <- data.frame(crop = c('CORN','SOYBEANS','WHEAT','SORGHUM','GRASS',
                                    'FALLOW'),
                           CropMod = c('C','S','C','S','S','S'),
                           SpeciesID = c('MZ','SB','WH','SG','PA','FA'),
                           cultivar = c('MZH',NA,'IB1015',NA,NA,NA),
                           tillage = c('R','R','N','N','N','N'),
                           numFertEvents = c(2,0,1,0,0,0))

#  to add rows for GRASS and FALLOW
grassFallow <- data.frame(year = rep(startYear:endYear,2),
                          crop = c('GRASS','FALLOW'),
                          plantingDOY_50 = NA,
                          harvestedDOY_50 = NA,
                          plantYear = NA,
                          harvYear = NA)

# join and keep key fields
cropManagement00 <- dates %>%
    mutate(plantYear = year(ymd(plantingDate_50)),
           harvYear = year(ymd(harvestDate_50))) %>%
  select(c('year','crop','plantingDOY_50','harvestedDOY_50','plantYear',
           'harvYear')) 

# add fallow and grass
cropManagement <- rbind(cropManagement00, grassFallow) %>%
  left_join(cropParamKey) %>%
  filter( year <= 2016) %>%
  arrange(year, crop)
```


## Extract Lema scenarios
Load the unique experiments  

### Test: develop for small subset

```{r getCombos}
# load 'lemaExps' from 2.21
comboDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/combinationGrids/spatialFilters'
load(file = paste0(comboDir,'/uniqueExperiments_gmd4p_Sheridan6.RData'))

# how to break down into xml files? by NLDAS or NLDAS + soil?
lemaExps2 <- lemaExps %>% 
  mutate(nldas = str_sub(ExpCode, start = 10, end = 13),
         state = str_sub(ExpCode, start = 1, end = 3),
         mukey = str_sub(ExpCode, start = 3, end = 9),
         static = str_sub(ExpCode, start = 1, end = 13)) 

# get a small subset of Experiments
expt_set <- lemaExps2 %>% filter(static == '2011499941122')

# translate variables in parameters needed to specify experiment tag
exp_master <- salustools::makeExperimentTable(runTitle, expt_set$ExpID, expt_set$mukey,
                                              expt_set$nldas, wheatStart, Nyrs, startDOY)


## break point: next task: translate crop sequence into rotational info
# basically: extract a year and crop column, then merge with management table
# but make this for every experiment looped through

# and will need to add functions:
# autoharvest
# auto irrigation
# otehr crops?


# table of annual specifications: median planting and harvest dates, fertililzation,
# and other component parameters
annualSpecs <- wheatDates %>%
  mutate(plantYear = year(ymd(plantingDate_50)),
         harvYear = year(ymd(harvestDate_50))) %>%
  select(c('year','crop','plantingDOY_50','harvestedDOY_50','plantYear','harvYear')) %>%
  # add a generic fertilization date and amount
  mutate(fertDOY = 75,
         Nfert = 78.47,
         irrig = 'N',
         fertilize = 'R',
         tillage = 'N',
         harvest = 'R',
         cropModel = 'C',
         species = 'WH',
         cultivar = 'P25R40') %>%
  filter(year <= 2016)




outFile2 <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/SALUS/testGUIrun/lemaWheatContinuous/lema_wheat_continuous.xdb.xml'

# Write the file! --------------------------------------------------------------

# initialize the file
write_xdb_topMatter(outFile2)

# for each experiment:
for(i in 1:nrow(exp_master)){  
  # write each set of experiment parameters
  write_xdb_experiment(outFile2, exp_master$ExpID[i], exp_master$runTitle[i], 
                       exp_master$startYear[i], exp_master$Nyrs[i], exp_master$startDOY[i], 
                       exp_master$nldas[i], exp_master$weatherfp[i], exp_master$soilId[i], 
                       exp_master$soilfp[i], exp_master$cropfp[i])
  # write rotation and management parameters for each year
  for(m in 1:nrow(annualSpecs)){
    # rotation parameters
    write_xdb_rotation(outFile2, m, annualSpecs$crop[m], annualSpecs$irrig[m], 
                       annualSpecs$fertilize[m], annualSpecs$tillage[m], 
                       annualSpecs$harvest[m])
    # management: planting
    write_xdb_mPlanting(outFile2, annualSpecs$cropModel[m], annualSpecs$species[m], 
                        annualSpecs$cultivar[m], annualSpecs$plantYear[m], 
                        annualSpecs$plantingDOY_50[m])
    # management: fertilize
    write_xdb_mFertilize(outFile2, annualSpecs$harvYear[m], annualSpecs$fertDOY[m],
                         annualSpecs$Nfert[m])
    # management: harvest
    write_xdb_mHarvest(outFile2, annualSpecs$harvYear[m], annualSpecs$harvestedDOY_50[m], 
                       closeComponent = 'Y')
  }  
  # close rotations and experiment
  write_xdb_bottomMatter(outFile2, closeRotation = 'Y', closeExperiment = 'Y')
}  
# close out
write_xdb_bottomMatter(outFile2, writeVersion = 'Y', closeXDB = 'Y')
```

Hey, that worked like a charm, first go!

## Examine results
Specifically interested in the soil water to determine good start dates for annual reinitialization


