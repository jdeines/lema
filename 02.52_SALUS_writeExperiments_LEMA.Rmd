---
title: "Generate Salus Experiment Files"
author: "Jill Deines"
date: "November 23, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Make Experiment Files; here, for LEMA, historical, auto irrigation. Strategy: make 1 file for each NLDAS grid, containing all experiments. Or maybe for each NLDAS/soil combo.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.52_salus_expt_lema/',
                      cache = TRUE, cache.path='cache/02.52_salus_expt_lema/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(stringr)
library(sf)
library(salustools) # from Jill's github
library(lubridate)
library(viridis)
```

**Directories**

```{r dirs}
rootDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus'
expSubDir <- '/experiments/LEMA_historical_autoIrrigation_v01'
expFileSuffix <- '_LEMA_hist_auto.xdb.xml'
```

## Extract some management info
Combine planting dates, spacing information, cultivars, etc

From Lydia and Brian:  

**Cultivars:**

* maize: complex model, cultivar MZH, speciesID 'MZ'
* wheat: complex model, cultivar IB1015, 'WH'
  * also a simple winter wheat: 'WW'
* soybeans: simple model (no cultivars) - species ID = 'SB'
* sorghum: simple model (no cultivars) - 'SG'
* grassland - a few grasses or generic pasture. 
  * grass-weeds, speciesID ='GW' - possible complex?
  * generic-pasture: 'PA' - definitely a simple
* fallow: just set the planting date for the next crop and let bare soil run. There does also seem to be a Fallow option (speciesID 'FA')

```{r getManagement}
startYear <- 2006
endYear <- 2016

# load date file
managementDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/management'
dates <- read.csv(paste0(managementDir,'/NASS_dates_planting_maturity_harvest_KS_2006-2017_4crops_MEDIANs.csv'))

# crop parameter key
cropParamKey <- data.frame(crop = c('CORN','SOYBEANS','WHEAT','SORGHUM','GRASS',
                                    'FALLOW'),
                           CropMod = c('C','S','C','S','S','S'),
                           SpeciesID = c('MZ','SB','WH','SG','PA','FA'),
                           cultivar = c('MZH',NA,'IB1015',NA,NA,NA),
                           tillage = c('R','R','N','N','N','N'),
                           numFertEvents = c(2,0,1,0,0,0))

#  to add rows for GRASS and FALLOW
grassFallow <- data.frame(year = rep(startYear:endYear,2),
                          crop = c('GRASS','FALLOW'),
                          plantingDOY_50 = NA,
                          harvestedDOY_50 = NA,
                          plantYear = NA,
                          harvYear = NA)

# join and keep key fields
cropManagement00 <- dates %>%
    mutate(plantYear = year(ymd(plantingDate_50)),
           harvYear = year(ymd(harvestDate_50))) %>%
  select(c('year','crop','plantingDOY_50','harvestedDOY_50','plantYear',
           'harvYear')) 

# add fallow and grass
cropManagement <- rbind(cropManagement00, grassFallow) %>%
  left_join(cropParamKey) %>%
  filter( year <= 2016) %>%
  arrange(year, crop)
```


## Extract real world wheat scenarios
Load the unique experiments  

```{r getCombos}
# load 'lemaUnique' from 2.21
comboDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/combinationGrids/spatialFilters'
load(file = paste0(comboDir,'/uniqueExperiments_gmd4p_Sheridan6.RData'))


  
# parse into informative columns and extract dryland wheat in KS
uniqueSpread <- uniques %>%
  mutate(irr = str_sub(rasterCode, start = -1, end = -1),
         cdl = str_sub(rasterCode, start = -4, end = -2),
         nldas = str_sub(rasterCode, start = -8, end = -5),
         mukey = str_sub(rasterCode, start = -15, end = -9),
         state = str_sub(rasterCode, start = -17, end = -16)) %>%
  filter(cdl == '024' & irr == '0' & state == '20')

# keep only NLDAS grids within LEMA ------------------------------------------
# load nldas
weatherDir <- 'weather/nldas_Jill/nldas_centroidExtract'
weatherPolyName <- 'NLDAS_clipped_gmd4p.shp'
nldasPolys <- read_sf(paste(rootDir, weatherDir, weatherPolyName, sep = '/'))
# load lema
lema <- read_sf('C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/GIS/boundaries/Sheridan6_trace.shp') %>% st_transform(4326)
# get nldas cells
lemaNldas <- st_intersection(nldasPolys,lema)
lemagrids <- as.character(lemaNldas$gridCll)

uniqueLema <- uniqueSpread %>%
  filter(nldas %in% lemagrids)

# that gives 96 combinations. 
# actually, I just identified the largest soil polygon within LEMA in ArcGIS: 
# biggest: 2759231
# next biggest: 1150000

bestSoil <- uniqueLema %>% filter(mukey %in% c('2759231','1150000'))
bestSoil
```

Run these 11 experiments!

## Generate Experiment file for these dominant soils in LEMA
Run all 11 experiments to also see how my `write_xdb_*` functions scale when in use for actual scenarios

```{r lemaWheat, eval=FALSE}
# table of annual specifications: median planting and harvest dates, fertililzation,
# and other component parameters
annualSpecs <- wheatDates %>%
  mutate(plantYear = year(ymd(plantingDate_50)),
         harvYear = year(ymd(harvestDate_50))) %>%
  select(c('year','crop','plantingDOY_50','harvestedDOY_50','plantYear','harvYear')) %>%
  # add a generic fertilization date and amount
  mutate(fertDOY = 75,
         Nfert = 78.47,
         irrig = 'N',
         fertilize = 'R',
         tillage = 'N',
         harvest = 'R',
         cropModel = 'C',
         species = 'WH',
         cultivar = 'P25R40') %>%
  filter(year <= 2016)

# Experiment Table
exp_master <- bestSoil %>%
  mutate(soilId = paste0('KS',mukey)) %>%
  select(c(nldas, soilId)) %>%
  mutate(soilfp = 'KS.sdb.xml',
         weatherfp = paste0(nldas,'.wdb.xml'),
         ExpID = 1:nrow(bestSoil),
         runTitle = paste0('Wheat-',soilId,'-',nldas),
         startYear = 2005,
         Nyrs = 11,
         startDOY = 265,
         cropfp = 'cropsn29Dec2016.cdb.xml')


outFile2 <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/SALUS/testGUIrun/lemaWheatContinuous/lema_wheat_continuous.xdb.xml'

# Write the file! --------------------------------------------------------------

# initialize the file
write_xdb_topMatter(outFile2)

# for each experiment:
for(i in 1:nrow(exp_master)){  
  # write each set of experiment parameters
  write_xdb_experiment(outFile2, exp_master$ExpID[i], exp_master$runTitle[i], 
                       exp_master$startYear[i], exp_master$Nyrs[i], exp_master$startDOY[i], 
                       exp_master$nldas[i], exp_master$weatherfp[i], exp_master$soilId[i], 
                       exp_master$soilfp[i], exp_master$cropfp[i])
  # write rotation and management parameters for each year
  for(m in 1:nrow(annualSpecs)){
    # rotation parameters
    write_xdb_rotation(outFile2, m, annualSpecs$crop[m], annualSpecs$irrig[m], 
                       annualSpecs$fertilize[m], annualSpecs$tillage[m], 
                       annualSpecs$harvest[m])
    # management: planting
    write_xdb_mPlanting(outFile2, annualSpecs$cropModel[m], annualSpecs$species[m], 
                        annualSpecs$cultivar[m], annualSpecs$plantYear[m], 
                        annualSpecs$plantingDOY_50[m])
    # management: fertilize
    write_xdb_mFertilize(outFile2, annualSpecs$harvYear[m], annualSpecs$fertDOY[m],
                         annualSpecs$Nfert[m])
    # management: harvest
    write_xdb_mHarvest(outFile2, annualSpecs$harvYear[m], annualSpecs$harvestedDOY_50[m], 
                       closeComponent = 'Y')
  }  
  # close rotations and experiment
  write_xdb_bottomMatter(outFile2, closeRotation = 'Y', closeExperiment = 'Y')
}  
# close out
write_xdb_bottomMatter(outFile2, writeVersion = 'Y', closeXDB = 'Y')
```

Hey, that worked like a charm, first go!

## Examine results
Specifically interested in the soil water to determine good start dates for annual reinitialization

### Soil water
Salus automatically chops subsurface into 20 layers denoted here: http://salusmodel.glg.msu.edu/tools/layers.html. Note the sw variable units is soil water content, m^3 / m^3

Here, I get the weighted average for the top 1.25 meter (first 9 layers) using:

* SW_tot = SW_lay * thick_lay/sum(thick_lay)

```{r salusOutput}
# load DAILY output
resultsDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/SALUS/testGUIrun/lemaWheatContinuous/results'
daily <- read_csv(paste0(resultsDir, '/salus.day.csv')) %>%
  select(c('Title','Year','DOY','PREC','SW(1)','SW(2)','SW(3)','SW(4)','SW(5)',
           'SW(6)','SW(7)','SW(8)','SW(9)'))

# set layer thicknesses, in meters
layerKey <- data.frame(layerNum = as.character(c(1:9)),
                       layerThick = c(2,5,8,11,14,17,20,23,25)/100)
sumThick <- sum(layerKey$layerThick)

# longify data, extract layer number as a column, join with layer thickness
sw_long <- daily %>% gather(key = swLayer, value = swContent.m3.m3, `SW(1)`:`SW(9)`) %>%
  mutate(layerNum = str_sub(swLayer, start = -2, end = -2)) %>%
  left_join(layerKey)

# get the weighted average for each DOY
sw_total <- sw_long %>%
  mutate(swTot_lay = swContent.m3.m3 * (layerThick / sumThick)) %>%
  group_by(Title, Year, DOY) %>%
  summarise(SWTot = sum(swTot_lay))
```

#### Plot: soil water

```{r plotSW_all}
ggplot(sw_total, aes(x = DOY, y = SWTot, color = as.factor(Year))) +
  geom_line() +
  scale_color_viridis(direction = -1, discrete=TRUE) +
  facet_wrap(~Title)

# just one Experiment
one <- sw_total %>% filter(Title == 'Wheat-KS2759231-1124')
ggplot(one, 
       aes(x = DOY, y = SWTot, color = as.factor(Year))) +
  geom_line() +
  scale_color_viridis(direction = -1, discrete=TRUE) +
  ggtitle('Surface water content by Year, dryland wheat')
```

Well, that's enough of an answer - soil water is highly variable among years, I should shoot for continuous.
