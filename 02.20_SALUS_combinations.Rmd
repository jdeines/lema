---
title: "Salus Combos"
author: "Jill Deines"
date: "November 5, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Create SALUS experiment combinations: unique soil-climate-crop-irrigation combos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.20_salus_combos/',
                      cache = TRUE)
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
library(rgdal)
library(raster)
library(tidyverse)
library(sf)
```

# directory parameters

```{r directories}
# root salus data directory
rootDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus'

# soil inputs
soilDir <- 'soil'
soilPolyName <- 'ssurgo_gmd4p_wgs84'

# crop type inputs
cdlDir <- 'cdl/cdl_rasters_lema'
cdlNameSuffix <- '_CDL_gmd4PlusClips_aea.tif'

# weather grid inputs
weatherDir <- 'weather\nldas_Jill\nldas_centroidExtract'
weatherPolyName <- 'NLDAS_clipped_gmd4p'

# irrigation map inputs
irrDir <- 'irrigationMaps'
irrNameSuffix <- '_gmd4plus_AIM-RRB_aea.tif'

# state polygons to split soils by
statesDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/GIS/boundaries'
statesName <- 'States_continental'

# study area boundary

```


# Static datasets
Soil and climate grid cell don't change over time. First, add these two together.

## load target grid
Each dataset needs to be reprojected to the same raster grid. I used the CDL grid as the target.

```{r makeGrid}
aeaProj <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
template <- raster(nrow = 4359, ncol = 7108, crs = aeaProj,
                    xmn = -522870, xmx = -309630, ymn = 1777860, 
                    ymx = 1908630) 
template[] <- 1:ncell(template)
```

## Soil: 
Load soil mukey polygons, append a state code to the mukeys, and sample to the raster grid

```{r loadsoil}
# load 
mukeys <- read_sf(paste0(rootDir,'/',soilDir,'/',soilPolyName,'.shp'))

# how long is longest mukey - this makes me laugh
maxdigits <- nchar(as.character(max(as.numeric(mukeys$MUKEY))))

# append a state code to each mukey to result in uniform length
fipsKey <- data.frame(state = c('CO','KS','NE'),
                      fips2 = c(8, 20, 31))
fipsKey$fips2 <- fipsKey$fips2 * 1*10^maxdigits

mukeys <- mukeys %>%
  mutate(state = substr(AREASYMBOL, 1,2)) %>% # extract state abbrev
  left_join(fipsKey) %>%                      # join fips
  mutate(MUKEY = as.numeric(MUKEY),
         stateMukey = MUKEY + fips2) %>%       # enhanced key!
  select(-c(SPATIALVER,Shape_Leng,Shape_Area)) # dump extra stuff

# put on the template grid
mukeys.spdf <- as(mukeys, 'Spatial')
mukeys.spdf <- spTransform(mukeys.spdf, CRS(aeaProj))

soilGrid <- rasterize(mukeys.spdf, template, field='stateMukey',background=NA)



# export for downstream use
writeRaster(soilGrid, paste0(rootDir,'/',soilDir,'/ssurgo_gmd4p_aea30.tif'))
```

455 unique soil types 

# load test cdl

```{r loadcdl}
cdltest2 <- raster(paste0(cdlDir,'/',cdlName))
nrow(cdltest)
length(unique(cdltest$class))
```

31 unique crop classes in 2015