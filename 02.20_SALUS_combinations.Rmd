---
title: "Salus Combos"
author: "Jill Deines"
date: "November 5, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Create SALUS experiment combinations: unique soil-climate-crop-irrigation combos

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.20_salus_combos/',
                      cache = TRUE, cache.path='cache/02.20_salus_combos/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
library(rgdal)
library(raster)
library(tidyverse)
library(sf)
```

# user parameters

```{r directories}
# years
yearsWanted <- 2006:2016

# root salus data directory
rootDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus'

# soil inputs
soilDir <- 'soil'
soilPolyName <- 'ssurgo_gmd4p_wgs84'

# crop type inputs
cdlDir <- 'cdl/cdl_rasters_lema'
cdlNameSuffix <- '_CDL_gmd4PlusClips_aea_top6.tif'

# weather grid inputs
weatherDir <- 'weather/nldas_Jill/nldas_centroidExtract'
weatherPolyName <- 'NLDAS_clipped_gmd4p'

# irrigation map inputs
irrDir <- 'irrigationMaps'
irrNameSuffix <- '_gmd4plus_AIM-RRB_aea.tif'

# bounding poly
gisDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/GIS/boundaries'
boundName <- 'GMD4_plus_aea'

# static grid export names
comboDir <- 'combinationGrids'
comboStaticName <- 'StaticVars_gmd4p_aea30.tif'
comboDynamicName <- '_gmd4p_combos_top6_aea30.tif'
comboMasterFile <- 'gmd4p_combos_top6_master.RData'
allUnique <- 'allUnique_gmd4p_top6_2006-2016.csv'
annualUnique <- 'annualUnique_gmd4p_top6_2006-2016.RData'
```


# Static datasets
Soil and climate grid cell don't change over time. First, add these two together.

## load target grid
Each dataset needs to be reprojected to the same raster grid. I used the CDL grid as the target.

```{r makeGrid}
aeaProj <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
template <- raster(nrow = 4359, ncol = 7108, crs = aeaProj,
                    xmn = -522870, xmx = -309630, ymn = 1777860, 
                    ymx = 1908630) 
template[] <- 1:ncell(template)
```

## Soil: 
Load soil mukey polygons, append a state code to the mukeys, and sample to the raster grid

```{r gridsoil}
# load 
mukeys <- read_sf(paste0(rootDir,'/',soilDir,'/',soilPolyName,'.shp'))
# how many soil types?
length(unique(mukeys$MUKEY))

# how long is longest mukey - this makes me laugh
maxdigits <- nchar(as.character(max(as.numeric(mukeys$MUKEY))))

# append a state code to each mukey to result in uniform length
fipsKey <- data.frame(state = c('CO','KS','NE'),
                      fips2 = c(8, 20, 31))
fipsKey$fips2 <- fipsKey$fips2 * 1*10^maxdigits

mukeys <- mukeys %>%
  mutate(state = substr(AREASYMBOL, 1,2)) %>% # extract state abbrev
  left_join(fipsKey) %>%                      # join fips
  mutate(MUKEY = as.numeric(MUKEY),
         stateMukey = MUKEY + fips2) %>%       # enhanced key!
  select(-c(SPATIALVER,Shape_Leng,Shape_Area)) # dump extra stuff

# put on the template grid
mukeys.spdf <- as(mukeys, 'Spatial')
mukeys.spdf <- spTransform(mukeys.spdf, CRS(aeaProj))

soilGrid <- rasterize(mukeys.spdf, template, field='stateMukey',background=NA)

# tidy up the edges (soil polys extend beyond boundary)
bound <- readOGR(gisDir, boundName,verbose=FALSE)
proj4string(bound) <- proj4string(soilGrid)  # already same proj, just needs datum
soilGridMask <- mask(soilGrid, bound)

spplot(soilGridMask)

# export for downstream use
#writeRaster(soilGridMask, paste0(rootDir,'/',soilDir,'/ssurgo_gmd4p_aea30_mask.tif'))
```

455 unique soil types (probably a bit more once split by state)

## Weather
Similarly, sample the weather polygons to the template raster grid

```{r gridWeather}
# load weather
weatherPoly <- readOGR(paste0(rootDir,'/',weatherDir), weatherPolyName, verbose = F)
weatherPoly <- spTransform(weatherPoly, CRS(aeaProj))

# unique gridcells
length(unique(weatherPoly$gridCll))

# rasterize
weatherGrid <- rasterize(weatherPoly, template, field='gridCll',background=NA)
spplot(weatherGrid)

#writeRaster(soilGridMask, paste0(rootDir,'/',weatherDir,'/NLDAS_gmd4p_aea30.tif'))
```

137 unique weather grid cells from NLDAS

## Static Soil & Weather type raster
Combine soil and weather along with padded zeros for easy addition of crop/irrigation status in downstream step.

```{r staticGrid}
# add 8 zeros to the soil grid
static0 <- soilGridMask * 1e8

# add 4 zeros to the weather grid
weatherPadded <- weatherGrid * 1e4

# static master grid!
static <- static0 + weatherPadded

spplot(static, main = 'static soil/weather key')

# write out static grid
# static grid export names
comboDir <- 'combinationGrids'
comboStaticName <- 'StaticVars_gmd4p_aea30.tif'
#writeRaster(static, paste(rootDir, comboDir, comboStaticName, sep='/'))
```

# Dynamic SALUS Combo Maps.
Irrigation status and Crop type change annually. Combine annual CDL/irrigation status with the static soil/weather raster.


```{r combos, eval=FALSE}
# load static variable base raster
static <- raster(paste(rootDir, comboDir, comboStaticName, sep='/'))

# output df for combos
annualCombos <- setNames(data.frame(matrix(ncol = length(yearsWanted), 
                                           nrow=ncell(static))),
                         c(paste0('x',yearsWanted)))

for(year in yearsWanted){
  # cdl and irrigation annual files
  cdlName <- paste0(rootDir, '/', cdlDir, '/', year, cdlNameSuffix)  
  irrName <- paste0(rootDir, '/', irrDir, '/', year, irrNameSuffix)
  
  # load
  irrigation <- raster(irrName)
  cdl <- raster(cdlName)
  
  # fix the cdl mask exported from GEE (mask 0 values)
  cdl[cdl < 1] <- NA 
  
  # combine with irrigation and eliminate impossibilities
  cdlpad <- cdl*10
  cdlIrr <- cdlpad + irrigation
  
  # # how much irrigated grassland? for 2016, 0.016%
  # impossible <- freq(cdlIrr, value = 1761)
  # naCells <- freq(cdlIrr, value = NA)
  # percentImpossible <- impossible/(ncell(cdlIrr)-naCells)
  
  # combo raster and export
  combo <- static + cdlIrr
  writeRaster(combo, paste0(rootDir, '/', comboDir, '/', year, comboDynamicName))
  
  # turn to vector, by row
  colNam <- paste0('x',year)
  annualCombos[,colNam] <- as.vector(t(as.matrix(combo)))
}

# save combo master
#save(annualCombos, file = paste0(rootDir, '/', comboDir, '/', comboMasterFile))
```

# Get Unique Experiments
Get unique combinations. I think I'm going to get the unique ones across the full time period, and run each for all years, to simplify having to specify what years to run for each experiment. maybe? maybe not. I don't know.

```{r unique, eval=FALSE}
# load
load(file = paste0(rootDir, '/', comboDir, '/', comboMasterFile))

# get all unique combos
uniques <- apply(annualCombos, 2, function(x) unique(x))

# get total unique across all years
combo.long <- gather(annualCombos, key = year, value = combo, x2006:x2016) 
allUniques <- unique(combo.long$combo)

# save both of these
write.csv(allUniques, row.names = F, file = paste0(rootDir, '/', comboDir, '/', allUnique))
save(uniques, file = paste0(rootDir, '/', comboDir, '/', annualUnique))
```

