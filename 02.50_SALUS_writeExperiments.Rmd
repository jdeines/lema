---
title: "Generate Salus Experiment Files"
author: "Jill Deines"
date: "November 23, 2017"
output: 
  html_document:
    toc: yes
---

Goal: Make Experiment Files; here, a continuous run of wheat

Functions to package up:

* write experiment file!

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figure/02.50_salus_expt/',
                      cache = TRUE, cache.path='cache/02.50_salus_expt/')
```

**R Packages Needed**

```{r packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(salustools) # from Jill's github
```

**Directories**

```{r dirs}
testDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/SALUS/testGUIrun/continuousWheat'
testFile <- 'wheat_continuous.xdb.xml'
```

## Extract some management info

```{r getManagement}
# load date file
managementDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/LEMAs/data/salus/management'
dates <- read.csv(paste0(managementDir,'/NASS_dates_planting_maturity_harvest_KS_2006-2017_4crops_MEDIANs.csv'))

# extract wheat means
wheatDates <- dates %>% filter(crop == 'WHEAT')
summary(wheatDates$plantingDOY_50)
summary(wheatDates$harvestedDOY_50, na.rm = TRUE)
```


# Test Xdb Functions
In the `salustools` package, I made a set of hopefully flexible functions to programmaticlly create a wide range of Experiment files. It was pieced together from examining the example .xdb.xmls', Lydia Rill and Brian Baer's python function, Lin's example, and SALUS help files

I think I will break this up into tiny buildable functions:

* write_xdb_topMatter
* write_xdb_experiment
* write_xdb_rotation (with argument for first rotation: starts section)
  * write_xdb_mPlanting - write planting parameters for crop rotation
  * write_xdb_mFertilize -
  * write_xdb_mHarvest
  * etc
* write_xdb_bottomMatter - closes above components as specified

Functions that could be added?

* write_xdb_measured_data - I don't think I have measured data yet? would be entered below experiment at the same level of Rotation Components

## Test: 2 wheat years
use functions to make an Experiment file for 2 wheat 

### Function parameters
list of parameter arguments. in production, the would be tied together 

```{r test_2wheat_parameters}
outFile <- paste0(testDir,'/', testFile)
# Experiment
ExpID <- 1
RunTitle <- 'wheatTest2'
startYear <- 2006
NYrs <- 3
startDOY <- 270
WthID <- '1001'
WthFile <- '1001.wdb.xml'
SoilID <- 'KS1017570'
SoilFile <- 'KS.sdb.xml'
CropFile <- 'cropsn29Dec2016.cdb.xml'
# rotation components
OrderNum <- 1
Title <- 'Wheat'
irrig <- 'N'  # 'N' - not, 'A' - auto, + more options
fertilize <- 'R' # R = reported date, 'A' - auto, 'N' - not
tillage <- 'N' # N = none, 'A' = automatic,, etc
harvest <- 'R' #R - reported, 'M' = at maturity
# management - planting
cropModel <- 'C' # C = complex, S = simple
species <- 'WH' # 'WH' = wheat
cultivar <- 'P25R40'
year <- 2006
PlantDOY <- 276 # median
# management - fertilizer
year_f <- 2007
fertDOY <- 75 
Nfert <- 78.47 # kg / ha
# management - harvest
year_h <- 2007
harvestDOY <- 178 
```

Build the Experiment Files from my functions!

```{r test_2wheat}
write_xdb_topMatter(outFile)
write_xdb_experiment(outFile, ExpID, RunTitle, startYear, NYrs, startDOY, 
                     WthID, WthFile, SoilID, SoilFile, CropFile)
# year 1
write_xdb_rotation(outFile, OrderNum, Title, irrig, fertilize, tillage, harvest)
write_xdb_mPlanting(outFile, cropModel, species, cultivar, year, PlantDOY)
write_xdb_mFertilize(outFile, year_f, fertDOY, Nfert)
write_xdb_mHarvest(outFile, year_h, harvestDOY, closeComponent = 'Y')
# year 2
write_xdb_rotation(outFile, OrderNum, Title, irrig, fertilize, tillage, harvest)
write_xdb_mPlanting(outFile, cropModel, species, cultivar, year+1, PlantDOY)
write_xdb_mFertilize(outFile, year_f+1, fertDOY, Nfert)
write_xdb_mHarvest(outFile, year_h+1, harvestDOY, closeComponent = 'Y')
# close out
write_xdb_bottomMatter(outFile, closeComponent = 'N', closeRotation = 'Y', 
                        closeExperiment = 'Y', writeVersion = 'Y', 
                        closeXDB = 'Y')
```




